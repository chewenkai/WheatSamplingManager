package com.aj.fragment;


import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;

import org.apache.ftpserver.FtpServer;
import org.apache.ftpserver.FtpServerFactory;
import org.apache.ftpserver.ftplet.FtpException;
import org.apache.ftpserver.listener.ListenerFactory;
import org.apache.ftpserver.usermanager.PropertiesUserManagerFactory;

import android.app.AlertDialog;
import android.app.AlertDialog.Builder;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.net.wifi.WifiManager;
import android.os.Bundle;
import android.os.Environment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.aj.Constant;
import com.aj.activity.DetecedUnit;
import com.aj.activity.MainActivity;
import com.aj.collection.R;
import com.aj.tools.SPUtils;

public class SettingFragment extends BaseFragment
{
	
	private LinearLayout unitBtn;
	private LinearLayout dataBtn;
	private LinearLayout versionBtn;
	private AlertDialog alertDialog;
	private AlertDialog.Builder builder;
	
	private FtpServer mFtpServer;	
	private int port =12345;// 端口号	
	private String ftpConfigDir = Environment.getExternalStorageDirectory().getAbsolutePath() 
			+ "/ftpConfig/";
	
	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container,
			Bundle savedInstanceState) {
		return inflater.inflate(R.layout.set_content,container,false);
	}
	
	@Override
	public void onResume() {
		super.onResume();
		MainActivity.currFragTag=Constant.FRAGMENT_FLAG_SETTING;
		unitBtn = (LinearLayout) getActivity().findViewById(R.id.unit_btn);
		unitBtn.setOnClickListener(new OnClickListener()
		{
			
			@Override
			public void onClick(View v)
			{
				// TODO Auto-generated method stub
				Intent i = new Intent(getActivity(), DetecedUnit.class);
				getActivity().startActivity(i);
			}
		});
		versionBtn = (LinearLayout)getActivity().findViewById(R.id.vertion_btn);
		versionBtn.setOnClickListener(new OnClickListener()
		{
			
			@Override
			public void onClick(View v)
			{
				// TODO Auto-generated method stub
				builder = new AlertDialog.Builder(getActivity());
				builder.setTitle("版本信息");
				builder.setMessage("抽样监督管理系统V1.0");
				alertDialog = builder.create();
				alertDialog.show();
			}
		});
		dataBtn = (LinearLayout) getActivity().findViewById(R.id.data_btn);
		dataBtn.setOnClickListener(new OnClickListener()
		{
			
			@Override
			public void onClick(View v)
			{
				// TODO Auto-generated method stub
				copyResourceFile(R.raw.users, ftpConfigDir + "users.properties");
				String info = "本机IP：\n" + getLocalIpAddress()
						+ "\n";
				File f = new File(ftpConfigDir);				
				if (!f.exists())					
					f.mkdir();				
				copyResourceFile(R.raw.users, ftpConfigDir + "users.properties");
				Config1();
				builder = new AlertDialog.Builder(getActivity());
				builder.setTitle("传输数据");
				builder.setMessage(info + "已启动连接，在断开之前请勿操作。");
				builder.setCancelable(false);
				builder.setPositiveButton("断开连接", new DialogInterface.OnClickListener()
				{
					@Override
					public void onClick(DialogInterface dialog, int which)
					{
						// TODO Auto-generated method stub
						AlertDialog ad ;
						AlertDialog.Builder ab = new AlertDialog.Builder(getActivity());
						ab.setTitle("温馨提示：");
						ab.setMessage("确认断开连接?");
						ab.setCancelable(false);
						ab.setPositiveButton("是", new DialogInterface.OnClickListener()
						{
							
							@Override
							public void onClick(DialogInterface dialog, int which)
							{
								// TODO Auto-generated method stub
								mFtpServer.stop();
							}
						});
						ab.setNegativeButton("否", new DialogInterface.OnClickListener()
						{
							
							@Override
							public void onClick(DialogInterface dialog, int which)
							{
								// TODO Auto-generated method stub
								alertDialog.show();
							}
						});
						ad = ab.create();
						ad.show();
					}
				});
				alertDialog = builder.create();
				alertDialog.show();
			}
		});
	}
	public String getLocalIpAddress() 
	{		
		WifiManager wifiManager = (WifiManager)getActivity(). getSystemService(getActivity().WIFI_SERVICE);
		int ip = wifiManager.getConnectionInfo().getIpAddress();
		String realIp = intToIp(ip);
		return realIp;
	}	
	public String intToIp(int ip)
	{
		return (ip & 0xFF) + "." + ((ip >> 8) & 0xFF) + "." +((ip >> 16) & 0xFF) +
				"." + ((ip >> 24) & 0xFF);
	}
	private void copyResourceFile(int rid, String targetFile) 
	{	
		InputStream fin = (getActivity().getApplicationContext()).getResources().openRawResource(rid);	
		FileOutputStream fos = null;	
		int length;		
		try 
		{		
			fos = new FileOutputStream(targetFile);		
			byte[] buffer = new byte[1024];		
			while ((length = fin.read(buffer)) != -1)
			{				
				fos.write(buffer, 0, length);			
			}		
		} 
		catch (FileNotFoundException e) 
		{		
			e.printStackTrace();	
		} 
		catch (IOException e) 
		{		
			e.printStackTrace();	
		} 
		finally {		
			if (fin != null) 
			{			
				try 
				{			
					fin.close();	
				}
				catch (IOException e)
				{				
					e.printStackTrace();
				}			
			}			
			if (fos != null)
			{			
				try {		
					fos.close();	
				}catch (IOException e) {				
					e.printStackTrace();		
				}		
			}		
		}	
	}	
	void Config1() {	
		FtpServerFactory serverFactory = new FtpServerFactory();	
		ListenerFactory factory = new ListenerFactory();
		factory.setPort(port);
		PropertiesUserManagerFactory userManagerFactory = new PropertiesUserManagerFactory();
		String[] str = { "mkdir", ftpConfigDir };	
		try
		{		
			Process ps = Runtime.getRuntime().exec(str);	
			try
			{			
				ps.waitFor();		
			} catch (InterruptedException e) {		
				e.printStackTrace();		
			}		
		}
		catch (IOException e) 
		{			
			e.printStackTrace();	
		}		
		String filename = ftpConfigDir + "users.properties";	
		System.out.println("ftpConfig is "+filename);
		File files = new File(filename);	
		userManagerFactory.setFile(files);	
		serverFactory.setUserManager(userManagerFactory.createUserManager());
			
		try
		{		
			serverFactory.addListener("default",factory.createListener());	
			FtpServer server = serverFactory.createServer();	
			this.mFtpServer = server;			
			server.start();	
		}
		catch (FtpException e) 
		{		
			e.printStackTrace();	
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
	}
	@Override
	public void onDetach()
	{
		// TODO Auto-generated method stub
		super.onDetach();
		if (null != mFtpServer)
		{		
			mFtpServer.stop();		
			mFtpServer = null;	
		}
	}
}
